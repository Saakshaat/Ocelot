<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <meta name="google-signin-client_id" content="883053712992-bp84lpgqrdgceasrhvl80m1qi8v2tqe9.apps.googleusercontent.com">
    <title>paws</title>
</head>

<body>

    <div id="my-signin2"></div>
    <script>
        async function onSuccess(googleUser) {

            console.log('Logged in as: ' + googleUser.getBasicProfile().getName());

            var id_token = googleUser.getAuthResponse().id_token; // get id token

            let url = 'https://us-central1-umass-compsci220.cloudfunctions.net/paws/login';
            // domain to send post requests to

            if (window.location.host.substring(0, 9) === 'localhost') { // if hosted on localhost
                url = 'http://localhost:8000/login'; 
            }

            const data = { token: id_token }; // data to be sent

            try {
                const response = await fetch(url, { // send json data to specified URL
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const jsonResponse = await response.json(); // get json response

                console.log('Getting response...'); // probably loading screen here to tell user to wait

                if (jsonResponse.message === 'Unauthorized') { // if messaged back as unauthorized
                    signOut(); // sign user out
                    return;
                }

                console.log("You're logged in!"); // if not, they are logged in 

            } catch (error) {
                console.error('Error', error);
                signOut();
            }
        }

        function onFailure(error) {
            console.log(error);
        }

        function renderButton() {
            gapi.signin2.render('my-signin2', {
                'scope': 'profile email',
                'width': 240,
                'height': 50,
                'longtitle': true,
                'theme': 'dark',
                'onsuccess': onSuccess,
                'onfailure': onFailure
            });
        }
    </script>

    <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>

    <a href="#" onclick="signOut();">Sign out</a>
    <script>
        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
            });
        }
    </script>

</body>

</html>